<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nala Aircon - Analytics Dashboard</title>
    
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Date-fns for date manipulation -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.0.0/index.min.js"></script>
    
    <!-- Simple ARIMA implementation -->
    <script src="https://cdn.jsdelivr.net/npm/arima@2.2.3/lib/arima.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .quick-access {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .quick-btn {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-decoration: none;
            color: #333;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .quick-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .quick-btn .icon {
            font-size: 2em;
        }

        .quick-btn .text h3 {
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #667eea;
        }

        .quick-btn .text p {
            font-size: 0.9em;
            color: #999;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .metric-card h3 {
            color: #999;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .metric-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .metric-card .change {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        .metric-card .change.positive {
            background: #d4edda;
            color: #155724;
        }

        .metric-card .change.negative {
            background: #f8d7da;
            color: #721c24;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-container h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .forecast-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }

        .forecast-info h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .forecast-info p {
            color: #666;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .forecast-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .forecast-controls label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
        }

        .forecast-controls select {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .forecast-controls select:focus {
            outline: none;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .charts-row {
                grid-template-columns: 1fr;
            }

            .chart-wrapper {
                height: 300px;
            }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Nala Aircon Analytics Dashboard</h1>
            <p>Real-time Business Intelligence & ARIMA Forecasting</p>
        </div>

        <div class="quick-access">
            <a href="https://databasenala.netlify.app" target="_blank" class="quick-btn">
                <div class="icon">üë•</div>
                <div class="text">
                    <h3>Database Nala</h3>
                    <p>Customer Management</p>
                </div>
            </a>
            <a href="https://kpinala.netlify.app" target="_blank" class="quick-btn">
                <div class="icon">üîß</div>
                <div class="text">
                    <h3>KPI Nala</h3>
                    <p>Technician Monitoring</p>
                </div>
            </a>
            <a href="https://kasnala.netlify.app" target="_blank" class="quick-btn">
                <div class="icon">üí∞</div>
                <div class="text">
                    <h3>Kas Nala</h3>
                    <p>Finance Dashboard</p>
                </div>
            </a>
            <a href="https://nalabi.netlify.app" target="_blank" class="quick-btn">
                <div class="icon">üìã</div>
                <div class="text">
                    <h3>Nala BI</h3>
                    <p>Project Management</p>
                </div>
            </a>
        </div>

        <div id="loadingMessage" class="loading">
            ‚è≥ Memuat data dari Firebase...
        </div>

        <div id="errorMessage" style="display: none;" class="error-message"></div>

        <div id="mainContent" style="display: none;">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="icon">üí∞</div>
                    <h3>Total Revenue</h3>
                    <div class="value" id="totalRevenue">Rp 0</div>
                    <span class="change positive" id="revenueChange">+0%</span>
                </div>
                <div class="metric-card">
                    <div class="icon">üìã</div>
                    <h3>Active Projects</h3>
                    <div class="value" id="totalProjects">0</div>
                    <span class="change positive" id="projectChange">+0%</span>
                </div>
                <div class="metric-card">
                    <div class="icon">üë•</div>
                    <h3>Total Customers</h3>
                    <div class="value" id="totalCustomers">0</div>
                    <span class="change positive" id="customerChange">+0%</span>
                </div>
                <div class="metric-card">
                    <div class="icon">üîß</div>
                    <h3>Avg Technician Score</h3>
                    <div class="value" id="avgKPI">0</div>
                    <span class="change positive" id="kpiChange">+0%</span>
                </div>
            </div>

            <div class="chart-container">
                <h2>üìà Revenue Forecasting (ARIMA)</h2>
                <div class="forecast-controls">
                    <label>
                        <span>Forecast Period:</span>
                        <select id="revenueForecastPeriod">
                            <option value="3">3 Months</option>
                            <option value="6" selected>6 Months</option>
                            <option value="12">12 Months</option>
                        </select>
                    </label>
                </div>
                <div class="chart-wrapper">
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="forecast-info">
                    <h4>üí° Forecast Insights</h4>
                    <p id="revenueForecastInsight">Analizing historical revenue data...</p>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-container">
                    <h2>üìä Project Volume Forecast</h2>
                    <div class="forecast-controls">
                        <label>
                            <span>Forecast Period:</span>
                            <select id="projectForecastPeriod">
                                <option value="3">3 Months</option>
                                <option value="6" selected>6 Months</option>
                                <option value="12">12 Months</option>
                            </select>
                        </label>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="projectChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üë• Customer Growth Forecast</h2>
                    <div class="forecast-controls">
                        <label>
                            <span>Forecast Period:</span>
                            <select id="customerForecastPeriod">
                                <option value="3">3 Months</option>
                                <option value="6" selected>6 Months</option>
                                <option value="12">12 Months</option>
                            </select>
                        </label>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="customerChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h2>üîß Technician Performance Overview</h2>
                <div class="chart-wrapper">
                    <canvas id="kpiChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configs
        const firebaseConfig1 = {
            apiKey: "AIzaSyBI5T3ZVyHXSRFikTjSlnW9P04cO1UDAwg",
            authDomain: "databasebesar.firebaseapp.com",
            projectId: "databasebesar",
            storageBucket: "databasebesar.firebasestorage.app",
            messagingSenderId: "253231829334",
            appId: "1:253231829334:web:e46fd18ef04b83d6c546f7",
            measurementId: "G-7387ZN5BJG"
        };

        const firebaseConfig2 = {
            apiKey: "AIzaSyASArMgCz6lXELa92V1BFe-5ecY__Seauc",
            authDomain: "financenala.firebaseapp.com",
            projectId: "financenala",
            storageBucket: "financenala.firebasestorage.app",
            messagingSenderId: "259185907850",
            appId: "1:259185907850:web:7278f2e27f658add34f573",
            measurementId: "G-ZPFH95WW9M"
        };

        // Initialize Firebase Apps
        const app1 = initializeApp(firebaseConfig1, "databasebesar");
        const app2 = initializeApp(firebaseConfig2, "financenala");

        const db1 = getFirestore(app1);
        const db2 = getFirestore(app2);

        // Chart instances
        let revenueChart, projectChart, customerChart, kpiChart;

        // Simple ARIMA-like forecasting function
        function simpleARIMAForecast(data, periods) {
            if (data.length < 3) {
                // Not enough data, use simple linear extrapolation
                const lastValue = data[data.length - 1] || 0;
                const growth = data.length > 1 ? (data[data.length - 1] - data[data.length - 2]) : 0;
                return Array.from({length: periods}, (_, i) => Math.max(0, lastValue + growth * (i + 1)));
            }

            // Calculate moving average
            const ma = [];
            const window = Math.min(3, data.length);
            for (let i = window - 1; i < data.length; i++) {
                const sum = data.slice(i - window + 1, i + 1).reduce((a, b) => a + b, 0);
                ma.push(sum / window);
            }

            // Calculate trend
            const trend = ma.length > 1 ? (ma[ma.length - 1] - ma[0]) / ma.length : 0;

            // Forecast
            const lastMA = ma[ma.length - 1] || data[data.length - 1] || 0;
            const forecast = [];
            for (let i = 0; i < periods; i++) {
                const predicted = lastMA + trend * (i + 1);
                forecast.push(Math.max(0, predicted));
            }

            return forecast;
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Format number
        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }

        // Generate month labels
        function generateMonthLabels(count, startFromNow = false) {
            const labels = [];
            const now = new Date();
            const startMonth = startFromNow ? now : new Date(now.getFullYear(), now.getMonth() - count + 1, 1);
            
            for (let i = 0; i < count; i++) {
                const date = new Date(startMonth.getFullYear(), startMonth.getMonth() + i, 1);
                labels.push(date.toLocaleDateString('id-ID', { month: 'short', year: 'numeric' }));
            }
            return labels;
        }

        // Load and process data
        async function loadData() {
            try {
                // Load transactions
                const transactionsSnapshot = await getDocs(collection(db2, 'transactions'));
                const transactions = [];
                transactionsSnapshot.forEach(doc => {
                    transactions.push({id: doc.id, ...doc.data()});
                });

                // Load projects
                const projectsSnapshot = await getDocs(collection(db1, 'nala_projects'));
                const projects = [];
                projectsSnapshot.forEach(doc => {
                    projects.push({id: doc.id, ...doc.data()});
                });

                // Load customers
                const customersSnapshot = await getDocs(collection(db1, 'customers'));
                const customers = [];
                customersSnapshot.forEach(doc => {
                    customers.push({id: doc.id, ...doc.data()});
                });

                // Load KPI
                const kpiSnapshot = await getDocs(collection(db1, 'kpi_teknisi'));
                const kpiData = [];
                kpiSnapshot.forEach(doc => {
                    kpiData.push({id: doc.id, ...doc.data()});
                });

                // Process data
                processAndDisplayData(transactions, projects, customers, kpiData);

                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = 'Error loading data: ' + error.message;
            }
        }

        function processAndDisplayData(transactions, projects, customers, kpiData) {
            // Calculate total revenue
            const totalRevenue = transactions.reduce((sum, t) => {
                if (t.type === 'income') return sum + (t.amount || 0);
                if (t.type === 'expense') return sum - (t.amount || 0);
                return sum;
            }, 0);

            // Group revenue by month
            const revenueByMonth = {};
            transactions.forEach(t => {
                if (t.date && t.type === 'income') {
                    const date = t.date.toDate ? t.date.toDate() : new Date(t.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    revenueByMonth[monthKey] = (revenueByMonth[monthKey] || 0) + (t.amount || 0);
                }
            });

            // Group projects by month
            const projectsByMonth = {};
            projects.forEach(p => {
                if (p.createdAt) {
                    const date = p.createdAt.toDate ? p.createdAt.toDate() : new Date(p.createdAt);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    projectsByMonth[monthKey] = (projectsByMonth[monthKey] || 0) + 1;
                }
            });

            // Group customers by month
            const customersByMonth = {};
            customers.forEach(c => {
                if (c.createdAt) {
                    const date = c.createdAt.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    customersByMonth[monthKey] = (customersByMonth[monthKey] || 0) + 1;
                }
            });

            // Update metric cards
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalProjects').textContent = formatNumber(projects.length);
            document.getElementById('totalCustomers').textContent = formatNumber(customers.length);
            
            const avgKPI = kpiData.length > 0 ? 
                kpiData.reduce((sum, k) => sum + (k.score || 0), 0) / kpiData.length : 0;
            document.getElementById('avgKPI').textContent = avgKPI.toFixed(1);

            // Create charts
            createRevenueChart(revenueByMonth);
            createProjectChart(projectsByMonth);
            createCustomerChart(customersByMonth);
            createKPIChart(kpiData);

            // Setup forecast period listeners
            document.getElementById('revenueForecastPeriod').addEventListener('change', () => {
                createRevenueChart(revenueByMonth);
            });
            document.getElementById('projectForecastPeriod').addEventListener('change', () => {
                createProjectChart(projectsByMonth);
            });
            document.getElementById('customerForecastPeriod').addEventListener('change', () => {
                createCustomerChart(customersByMonth);
            });
        }

        function createRevenueChart(revenueByMonth) {
            const ctx = document.getElementById('revenueChart');
            if (revenueChart) revenueChart.destroy();

            // Prepare historical data (last 12 months)
            const historicalMonths = 12;
            const labels = generateMonthLabels(historicalMonths);
            const now = new Date();
            const historicalData = labels.map((label, idx) => {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - historicalMonths + idx + 1, 1);
                const monthKey = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}`;
                return revenueByMonth[monthKey] || 0;
            });

            // Get forecast period
            const forecastPeriods = parseInt(document.getElementById('revenueForecastPeriod').value);
            const forecast = simpleARIMAForecast(historicalData, forecastPeriods);
            const forecastLabels = generateMonthLabels(forecastPeriods, true);

            // Calculate confidence intervals (simple approach)
            const forecastUpper = forecast.map(v => v * 1.15);
            const forecastLower = forecast.map(v => v * 0.85);

            // Combine labels
            const allLabels = [...labels, ...forecastLabels];
            const historicalDisplay = [...historicalData, ...Array(forecastPeriods).fill(null)];
            const forecastDisplay = [...Array(historicalMonths).fill(null), ...forecast];

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allLabels,
                    datasets: [
                        {
                            label: 'Historical Revenue',
                            data: historicalDisplay,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Forecast',
                            data: forecastDisplay,
                            borderColor: '#f093fb',
                            backgroundColor: 'rgba(240, 147, 251, 0.1)',
                            borderWidth: 3,
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });

            // Update insight
            const avgForecast = forecast.reduce((a, b) => a + b, 0) / forecast.length;
            const avgHistorical = historicalData.filter(v => v > 0).reduce((a, b) => a + b, 0) / historicalData.filter(v => v > 0).length || 0;
            const growth = avgHistorical > 0 ? ((avgForecast - avgHistorical) / avgHistorical * 100).toFixed(1) : 0;
            
            document.getElementById('revenueForecastInsight').textContent = 
                `Based on historical trends, forecasted average monthly revenue for the next ${forecastPeriods} months is ${formatCurrency(avgForecast)}, ` +
                `representing a ${growth}% ${growth >= 0 ? 'growth' : 'decline'} compared to historical average.`;
        }

        function createProjectChart(projectsByMonth) {
            const ctx = document.getElementById('projectChart');
            if (projectChart) projectChart.destroy();

            const historicalMonths = 12;
            const labels = generateMonthLabels(historicalMonths);
            const now = new Date();
            const historicalData = labels.map((label, idx) => {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - historicalMonths + idx + 1, 1);
                const monthKey = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}`;
                return projectsByMonth[monthKey] || 0;
            });

            const forecastPeriods = parseInt(document.getElementById('projectForecastPeriod').value);
            const forecast = simpleARIMAForecast(historicalData, forecastPeriods);
            const forecastLabels = generateMonthLabels(forecastPeriods, true);

            const allLabels = [...labels, ...forecastLabels];
            const historicalDisplay = [...historicalData, ...Array(forecastPeriods).fill(null)];
            const forecastDisplay = [...Array(historicalMonths).fill(null), ...forecast];

            projectChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: allLabels,
                    datasets: [
                        {
                            label: 'Historical Projects',
                            data: historicalDisplay,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 2
                        },
                        {
                            label: 'Forecast',
                            data: forecastDisplay,
                            backgroundColor: 'rgba(240, 147, 251, 0.8)',
                            borderColor: '#f093fb',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function createCustomerChart(customersByMonth) {
            const ctx = document.getElementById('customerChart');
            if (customerChart) customerChart.destroy();

            const historicalMonths = 12;
            const labels = generateMonthLabels(historicalMonths);
            const now = new Date();
            const monthlyNew = labels.map((label, idx) => {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - historicalMonths + idx + 1, 1);
                const monthKey = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}`;
                return customersByMonth[monthKey] || 0;
            });

            // Calculate cumulative
            const historicalData = [];
            let cumulative = 0;
            monthlyNew.forEach(count => {
                cumulative += count;
                historicalData.push(cumulative);
            });

            const forecastPeriods = parseInt(document.getElementById('customerForecastPeriod').value);
            const newCustomersForecast = simpleARIMAForecast(monthlyNew, forecastPeriods);
            
            const forecastData = [];
            newCustomersForecast.forEach(count => {
                cumulative += count;
                forecastData.push(cumulative);
            });

            const forecastLabels = generateMonthLabels(forecastPeriods, true);
            const allLabels = [...labels, ...forecastLabels];
            const historicalDisplay = [...historicalData, ...Array(forecastPeriods).fill(null)];
            const forecastDisplay = [...Array(historicalMonths).fill(null), ...forecastData];

            customerChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allLabels,
                    datasets: [
                        {
                            label: 'Historical Customers',
                            data: historicalDisplay,
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Forecast',
                            data: forecastDisplay,
                            borderColor: '#00f2fe',
                            backgroundColor: 'rgba(0, 242, 254, 0.1)',
                            borderWidth: 3,
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function createKPIChart(kpiData) {
            const ctx = document.getElementById('kpiChart');
            if (kpiChart) kpiChart.destroy();

            const techNames = kpiData.map(k => k.name || k.technicianName || 'Unknown');
            const scores = kpiData.map(k => k.score || 0);

            kpiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: techNames,
                    datasets: [{
                        label: 'Performance Score',
                        data: scores,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
